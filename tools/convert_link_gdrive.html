<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Konversi Link Google Drive Lengkap</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- jQuery -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <style>
    body {
      background-color: #f8f9fa;
      padding-top: 70px;
    }
    .card {
      max-width: 780px;
      margin: auto;
    }
    #resultLink {
      background-color: #f1f3f5;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="card shadow-sm">
      <div class="card-body">
        <h4 class="text-center fw-bold mb-4">Konversi Link Google Drive Otomatis</h4>
        
        <!-- Input -->
        <div class="mb-3">
          <label for="gdriveInput" class="form-label">Masukkan Link Google Drive:</label>
          <input type="text" id="gdriveInput" class="form-control" placeholder="https://drive.google.com/file/d/.../view?usp=sharing">
        </div>

        <!-- Jenis file -->
        <div class="mb-3">
          <label class="form-label">Tipe File Terdeteksi:</label>
          <input type="text" id="detectedType" class="form-control" readonly placeholder="Menunggu input...">
        </div>

        <!-- Pilihan tipe konversi -->
        <div class="mb-3">
          <label for="linkType" class="form-label">Pilih Jenis Konversi:</label>
          <select id="linkType" class="form-select">
            <option value="embed" selected>Embed Preview (aman di iframe)</option>
            <option value="inline">Inline / Direct (uc?id=...)</option>
            <option value="download">Download Langsung (uc?export=download&id=...)</option>
            <option value="preview">Preview UI Google (/file/d/.../preview)</option>
            <option value="exportpdf">Export ke PDF (Docs, Sheets, Slides)</option>
            <option value="exportcsv">Export ke CSV (untuk Sheets)</option>
            <option value="exportpptx">Export ke PPTX (untuk Slides)</option>
            <option value="legacy">Legacy Open (/open?id=...)</option>
            <option value="api">API Endpoint (/drive/v3/files/...)</option>
          </select>
        </div>

        <!-- Hasil -->
        <div class="mb-3">
          <label class="form-label">Hasil Konversi:</label>
          <div class="input-group">
            <input type="text" id="resultLink" class="form-control" readonly>
            <button id="copyBtn" class="btn btn-outline-primary" type="button">
              <i class="bi bi-clipboard"></i> Copy
            </button>
          </div>
        </div>

        <!-- Preview -->
        <div id="previewSection" class="text-center mt-4 d-none">
          <h6 class="fw-semibold mb-3">Preview File:</h6>
          <iframe id="previewFrame" width="100%" height="420px" class="border rounded"></iframe>
          <p class="text-muted mt-2 small">Preview hanya tersedia untuk tipe Embed / Preview UI.</p>
        </div>

        <!-- Pesan CSP -->
        <div id="blockedSection" class="alert alert-warning mt-4 d-none">
          <i class="bi bi-exclamation-triangle"></i> 
          Preview tidak dapat ditampilkan langsung karena pembatasan keamanan Google Drive (CSP). 
          Gunakan tombol <strong>Copy</strong> atau buka link secara langsung.
        </div>
      </div>
    </div>
  </div>

  <script>
    $(document).ready(function() {
      const $input = $('#gdriveInput');
      const $result = $('#resultLink');
      const $preview = $('#previewFrame');
      const $previewSection = $('#previewSection');
      const $blocked = $('#blockedSection');
      const $detected = $('#detectedType');

      function detectType(url) {
        if (/docs\.google\.com\/document/.test(url)) return 'Google Docs';
        if (/docs\.google\.com\/spreadsheets/.test(url)) return 'Google Sheets';
        if (/docs\.google\.com\/presentation/.test(url)) return 'Google Slides';
        if (/drive\.google\.com\/file/.test(url)) return 'File Upload (Generic)';
        if (/drive\.google\.com\/open/.test(url)) return 'Legacy File';
        return 'Tidak dikenali';
      }

      function generateLink(fileId, baseType, convType) {
        switch (convType) {
          case 'embed':
          case 'preview':
            return `https://drive.google.com/file/d/${fileId}/preview`;
          case 'inline':
            return `https://drive.google.com/uc?id=${fileId}`;
          case 'download':
            return `https://drive.google.com/uc?export=download&id=${fileId}`;
          case 'exportpdf':
            if (baseType === 'Google Docs') return `https://docs.google.com/document/d/${fileId}/export?format=pdf`;
            if (baseType === 'Google Sheets') return `https://docs.google.com/spreadsheets/d/${fileId}/export?format=pdf`;
            if (baseType === 'Google Slides') return `https://docs.google.com/presentation/d/${fileId}/export/pdf`;
            return `https://drive.google.com/uc?export=download&id=${fileId}`;
          case 'exportcsv':
            return `https://docs.google.com/spreadsheets/d/${fileId}/export?format=csv&id=${fileId}`;
          case 'exportpptx':
            return `https://docs.google.com/presentation/d/${fileId}/export/pptx`;
          case 'legacy':
            return `https://drive.google.com/open?id=${fileId}`;
          case 'api':
            return `https://www.googleapis.com/drive/v3/files/${fileId}?alt=media&key=YOUR_API_KEY`;
          default:
            return '';
        }
      }

      function updateOutput() {
        const url = $input.val().trim();
        const type = $('#linkType').val();
        const detected = detectType(url);
        $detected.val(detected);

        const regexFile = /https:\/\/drive\.google\.com\/file\/d\/([^\/]+)\//;
        const regexDocs = /https:\/\/docs\.google\.com\/(?:document|spreadsheets|presentation)\/d\/([^\/]+)\//;
        const match = url.match(regexFile) || url.match(regexDocs);

        if (match && match[1]) {
          const fileId = match[1];
          const newLink = generateLink(fileId, detected, type);
          $result.val(newLink);

          if (['embed', 'preview'].includes(type)) {
            $preview.attr('src', newLink);
            $previewSection.removeClass('d-none');
            $blocked.addClass('d-none');
          } else {
            $previewSection.addClass('d-none');
            $blocked.removeClass('d-none');
          }
        } else {
          $result.val('');
          $detected.val('Tidak dikenali');
          $previewSection.addClass('d-none');
          $blocked.addClass('d-none');
        }
      }

      // Event
      $input.on('input', updateOutput);
      $('#linkType').on('change', updateOutput);

      // Tombol Copy
      $('#copyBtn').on('click', function() {
        const link = $result.val();
        if (link) {
          navigator.clipboard.writeText(link).then(() => {
            $(this).text('Copied!').removeClass('btn-outline-primary').addClass('btn-success');
            setTimeout(() => {
              $(this).html('<i class="bi bi-clipboard"></i> Copy').removeClass('btn-success').addClass('btn-outline-primary');
            }, 1500);
          });
        }
      });
    });
  </script>
</body>
</html>
